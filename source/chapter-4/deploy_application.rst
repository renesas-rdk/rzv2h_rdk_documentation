.. _ros2_deployment:

Useful tool for development of ROS2 applications
------------------------------------------------------

This section provides instructions on deploying, debugging ROS2 applications to the Renesas RZ/V2H RDK platform.

.. attention::

   This method support the cross-build method using Yocto SDK only.

Prerequisites
^^^^^^^^^^^^^^^

1. Complete the :ref:`Common docker environment setup <docker_sdk_setup>` step as described in the **System Configuration** section.

2. Also, complete the :ref:`Cross-build the ROS2 Application using Yocto SDK <requirements_ros2_cross_build>` step as described in the **ROS2 Development** section.

3. The following structure is expected after cross-building the ROS2 application:

   .. code-block:: console

      ros2_ws/
      ├── build
      ├── .clang-format   # Clang format configuration file
      ├── cross.cmake
      ├── install         # Installation directory (generated by cross-colcon-build command)
      ├── log
      ├── src
      └── .vscode         # VS Code workspace configuration files

In case your workspace does not contain the ``.vscode/`` directory, you can copy it manually from the ``$TOOLCHAIN_WS`` directory.

4. Ensure your development machine has the following:

- Visual Studio Code (VS Code)
- Remote Development extension for VS Code
- C/C++ extension installed inside the development container

.. attention::

   - Your **development machine** can establish an SSH connection to the target board.

   - Please establish the first SSH connection using the ``ssh`` command to accept the host key.

   .. code-block:: bash

      $ ssh rz@<target_ip_address>

   - Your **target board** has both gdbserver and rsync installed. If not, you can install it using:

   .. code-block:: bash

      $ sudo apt install gdbserver rsync

.. _vs_code_ws:

VS Code Workspace Configuration
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

With the VS Code workspace configuration, you can easily deploy and remote debug your ROS2 applications on the RZ/V2H RDK platform.

VS Code configuration files are located in the ``.vscode/`` directory of your ROS2 workspace:

.. code-block:: text

    .vscode/
    ├── c_cpp_properties.json           # C/C++ extension configuration file
    ├── deploy.sh                       # Deployment script to copy files to target
    ├── launch.json                     # Debugger launch configuration file
    ├── run_program.sh                  # Script to run the program on target
    ├── settings.json                   # VS Code workspace settings file
    ├── settings.linux.json             # Linux-specific settings overrides
    ├── start_target_gdbserver.sh       # Script to start gdbserver on target
    └── tasks.json                      # Task runner configuration file

By default, the configuration files are set up by the Dockerfile during the Docker container creation.

Supported Features
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

The VS Code workspace configuration supports the following features:

Target for ROS2 Jazzy Remote Run/Debug for arm64 (RZ/V2H) with cross-build using Yocto SDK method.

VS Code Tasks
"""""""""""""""""

- **ROS2: SSH to Target** - Start an SSH session to the target board.
- **ROS2: Debug Run (GDB)** - Start remote debugging a ROS2 node using the ``ros2 run`` command with the GDB server.
- **ROS2: Debug Launch (GDB)** - Start remote debugging a ROS2 node within a launch file using the ``ros2 launch`` command with the GDB server.
- **ROS2: Run Package Executable** - Run a ROS2 node using the ``ros2 run`` command.
- **ROS2: Launch Package LaunchFile** - Run ROS2 nodes using the ``ros2 launch`` command.
- **ROS2: Deploy to Target** - Deploy the ``install`` folder to the target board.
- **ROS2: Build Debug** - Build the workspace with the *Debug* configuration.
- **ROS2: Build Release** - Build the workspace with the *Release* configuration.
- **ROS2: Clean All** - Clean all build artifacts (``build``, ``install``, ``log`` folders).

VS Code Launch Configurations
""""""""""""""""""""""""""""""""""

- **GDB for ROS2 Run** - Configure debugging in VS Code compatible with ROS2 *Run* debugging using GDB (``ros2 run``).
- **GDB for ROS2 Launch** - Configure debugging in VS Code compatible with ROS2 *Launch* debugging using GDB (``ros2 launch``).

.. note::

   All tasks support running with custom arguments.

   A prompt will be displayed for argument input on each execution.


.. tip::

   You can use the hot key ``Ctrl+Shift+P`` in VS Code and search for **Tasks: Run Tasks** to execute the tasks listed above.

Limitations:
""""""""""""""

- Only RZ/V2H (arm64) builds are supported.
- Only support debug one ROS node at a time (both ros2 run and ros2 launch).
- The speed can be slow if the install folder is large or the network connection is poor.

Prepare for Deployment
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

1. Use the ``Remote Development`` plugin for VS Code to start working inside the development Docker container.
2. Prepare the workspace following the :ref:`VS Code Workspace Configuration <vs_code_ws>`.
3. Modify the contents of ``c_cpp_properties.json`` in your workspace. For example, modify the ``includePath`` or related configuration in ``settings.json`` to match your workspace setup.
   This file is provided as a reference example only.
4. Open the ``settings.json`` file, then edit the following variables to match your development environment:

.. attention::

   The variables listed below are essential for the remote debugging and deployment workflow.

.. list-table:: Debug Configuration Variables
   :header-rows: 1
   :widths: 20 10 40 10 10

   * - Variable Name
     - Required
     - Description
     - ``ros2 run`` required
     - ``ros2 launch`` required
   * - ``HOST_GDB_PATH``
     - Optional
     - Path to the GDB executable on the host machine.
     -
     -
   * - ``TARGET_LOCAL_SYSROOT``
     - Optional
     - Path to the sysroot of the target device SDK (used for debugging).
     -
     -
   * - ``TARGET_IP``
     - **Yes**
     - IP address of the target device.
     - Yes
     - Yes
   * - ``TARGET_GDB_PORT``
     - Optional
     - GDB server port used on the target device.
     -
     -
   * - ``TARGET_USER``
     - Optional
     - Username used to connect to the target device.
     -
     -
   * - ``TARGET_PASSWORD``
     - Optional
     - Password used to authenticate the target connection.
     -
     -
   * - ``TARGET_ROS2_WS``
     - Optional
     - Target ROS2 workspace path (used for deployment).
     -
     -
   * - ``NODE_PACKAGE_NAME``
     - **Yes**
     - The ROS 2 package name that contains the executable.
     - Yes
     - For debug only
   * - ``NODE_EXECUTABLE_NAME``
     - **Yes**
     - The name of the executable to be launched.
     - Yes
     - For debug only
   * - ``LAUNCH_PACKAGE_NAME``
     - **Yes**
     - The ROS 2 package name that contains the launch file.
     - No
     - Yes
   * - ``LAUNCH_FILE_NAME``
     - **Yes**
     - The launch file used to start the ROS 2 application.
     - No
     - Yes

.. note::

   - Variables marked as *Optional* should be modified only if your development environment differs from the default one generated by the :file:`Dockerfile`.
   - Variables marked as **Required** must be set correctly each time you run a remote debug session; otherwise, the workflow will not operate properly.

When using this configuration, it will mimic the following commands on the target board:

.. code-block:: bash

   ros2 run <NODE_PACKAGE_NAME> <NODE_EXECUTABLE_NAME>

   ros2 launch <LAUNCH_PACKAGE_NAME> <LAUNCH_FILE_NAME>

Start Deployment
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Run the **ROS2: Deploy to Target** task in VS Code to deploy the ``install`` folder to the target board.

After deployment, please install any additional dependencies on the target device using:

.. code-block:: bash

    $ source /opt/ros/jazzy/setup.bash
    $ rosdep install --from-paths <path/to>install/*/share -y -r --ignore-src

Please replace ``<path/to>install/`` with the actual path to the ``install/`` directory on your RZ/V2H RDK board.

Start Running / Remote Debugging
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

1. Update the variables ``NODE_PACKAGE_NAME``, ``NODE_EXECUTABLE_NAME``, ``LAUNCH_PACKAGE_NAME`` and ``LAUNCH_FILE_NAME`` in the ``settings.json`` file to match the node you want to debug.
2. Build your workspace using the *Debug* build type (required for debugging):

   .. code-block:: bash

      cross-colcon-build --cmake-args -DCMAKE_BUILD_TYPE=Debug

3. Use **Run Task** or **Launch** to start your workflow.
4. Enter any custom arguments if prompted.
5. Begin debugging or running the application.

Example: Workflow
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Debugging ``foxglove_keypoint_publisher_node`` in ``demo_virtual_inspire_rh56_hands.launch.py`` from the RZ/V ROS Package

- In :file:`settings.json`, set the following variables:

  .. code-block:: json

     {
       "NODE_PACKAGE_NAME": "foxglove_keypoint_publisher",
       "NODE_EXECUTABLE_NAME": "foxglove_keypoint_publisher_node",
       "LAUNCH_PACKAGE_NAME": "rzv_demo_dexhand",
       "LAUNCH_FILE_NAME": "demo_virtual_inspire_rh56_hands.launch.py"
     }

- Build the workspace with *Debug* configuration using the VS Code task **ROS2: Build Debug** or the command:

  .. code-block:: bash

     cross-colcon-build --cmake-args -DCMAKE_BUILD_TYPE=Debug

- In VS Code, press ``Ctrl+Shift+D`` and select **GDB for ROS2 Launch**.
- Enter the custom arguments when prompted:

  .. code-block:: bash

     video_device:=/dev/video0

- Press ``Enter`` to start the debugging session.
  The following command will be executed on the target board:

  .. code-block:: bash

      $ ros2 launch --launch-prefix 'gdbserver localhost:2345' --launch-prefix-filter 'foxglove_keypoint_publisher_node' rzv_demo_dexhand demo_virtual_inspire_rh56_hands.launch.py

.. note::

   When debugging in ``ros2 launch`` mode:

   1. Set ``NODE_PACKAGE_NAME`` to the package containing the target executable.
   2. Set ``NODE_EXECUTABLE_NAME`` to the name of the executable to be debugged.

Troubleshooting
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

1. Can't deploy / remote run / remote debug:

   - Check the target IP, username, and password in the ``settings.json`` file.
   - Ensure the target board is powered on and connected to the network.
   - Verify that ``gdbserver`` and ``rsync`` are installed on the target board.
   - Establish the first SSH connection to the target board using the ``ssh command`` to accept the host key.
   - Delete the known hosts entry for the target IP in the ``~/.ssh/known_hosts`` file if the target board's host key has changed.

2. Remote debug fails to start or disconnects immediately:

   - Ensure the workspace is built with the *Debug* configuration.
   - Verify that the correct package and executable names are set in the ``settings.json`` file.
   - Check network stability between the host and target board.
   - Make sure the GDB server port is not blocked by a firewall or not used by other process.
